/* 3 state variables -> x, y, vx */
/* controls -> long. acceleration and lateral speed */
#include <stdio.h>
#include <time.h>
#include <filesystem>
 
// include other headers
#include "dionysis_controller.h"
#include "data.h"
#include "controllers.h"
#include "vehicle.h"
#include "dddp.h"
#include "ddp.h"
#include "idm.h"

using namespace std;

void deleteDirectoryContents(const std::__fs::filesystem::path& dir) {
    for (const auto& entry : std::__fs::filesystem::directory_iterator(dir)) 
        std::__fs::filesystem::remove_all(entry.path()); 
}

/* Colors */
#define RED   "\x1B[1;31m"
#define GRN   "\x1B[1;32m"
#define RESET "\x1B[0m"

int main() {

	clock_t tic, toc;
	double cpu_time;
	
    // clear all output folders
    string path;
    path = "../outputs/dddp/domain"; deleteDirectoryContents(path);
    path = "../outputs/dddp/solution"; deleteDirectoryContents(path);
    path = "../outputs/ddp/solution"; deleteDirectoryContents(path);
    path = "../outputs/idm/solution"; deleteDirectoryContents(path);
    path = "../outputs/feedback/solution"; deleteDirectoryContents(path);

	tic = clock();
	/* start procedure */

	// initialize and read data
	Data in;
	in.read();
    if (in.timeHorizon != 0.0)
        in.numsteps = in.timeHorizon / in.step;

	// Initialize vehicle(s)
	Vehicle veh(in);

    // IDM
    // IDM idm(veh, in.numsteps, in.step);
    // idm.idm_run();
    // idm.exportSimData(0);

    // use Dionysis controller for initial trajectory
    double d_step = 0.001;
    double tmax = in.numsteps*in.step;
    int d_numsteps = (int)tmax / d_step;
	Dionysis_Feedback fb(veh, d_numsteps, d_step, 1);
    fb.run(veh);
    fb.exportSimData(0);

    // solve with DDDP
    DDDP dddp(veh, in.numsteps, in.step, fb.opt_x, fb.opt_vx, fb.opt_y);
    // dddp.run(veh);
    // TODO: change discretizexv() --> use fmod? to get the closer grid point, in case interpolation is needed (zero interpolation) [for T != 1.0]
    // dddp.exportSimData(-1);

    // scenario 1
    // vector<double> testInit_ux = {0.791666666666667,0.743321912502202,0.695307773743023,0.648635847477733,0.602431540379565,0.555887470390391,0.508237920452552,0.458757774159201,0.406778266627585,0.351798740809494,0.293698905859124,0.233083643807592,0.171839525211347,0.113837303212077,0.0653857380538834,0.0344390043948153,0.0274633542268918,0.0449719313597559,0.0798347412816043,0.120571135371897,0.156186570457675,0.178869829021098,0.184686542598864,0.173869572314499,0.151172889558300,0.124823326017009,0.102565269087228,0.0877350867483626,0.0802393847749128,0.0802680914618452,0.0890781590659715,0.107549897292791,0.136139121400861,0.175394687235221,0.225777903108408,0.287579364333759,0.360803880223466,0.449081120131099,0.588128107850913,0.770726700586349,0.945470549511109,1.07325026129767,1.13948854234411,1.13662939591531,1.06816200017877,0.948554676767010,0.798709943664944,0.639670003136196,0.487925022785644,0.353449095639791,0.239888405150423,0.148228741161027,0.0778712904755149,0.0270534776544980,-0.00667162653849820,-0.0259924572551046,-0.0335123107392193,-0.0329275002874157,-0.0315995074730015,-0.0303250736867482,-0.0291020388495750,-0.0281705540898416,-0.0308061646329199,-0.0385353887212925,-0.0520209356519032,-0.0718418537499081,-0.0982313046391310,-0.133355739582056,-0.179202549461091,-0.232439047729944,-0.286825127523705,-0.334731958254149,-0.371800175498238,-0.402053974735397,-0.437106409832218,-0.487595179755954,-0.552852209271953,-0.614770907997979,-0.640170195177193,-0.598184241328846,-0.486235359351828,-0.334377977133323,-0.181062815007643,-0.0515794723731262,0.0456432034092126,0.113099925836447,0.157479886717456,0.185215820765863,0.201382925615446,0.209686868877972,0.212624474664682,0.211787181381009,0.208145155353977,0.202393340501899,0.195056450877489,0.186557404969616,0.177259205386340,0,0,0};
    // vector<double> testInit_uy = {0.232432932642816,0.113525672427252,0.0619278077907516,0.0438976689130972,0.0417508738543946,0.0481077560279368,0.0602863455191748,0.0778745070705855,0.101305566527501,0.131987886343790,0.171878479888313,0.222407926982378,0.282581570022469,0.345222291830825,0.392371660570237,0.396569266380197,0.338233929992199,0.228492841289309,0.100005683035931,-0.0284488299155177,-0.162364342448788,-0.313399002978136,-0.480272080683613,-0.635022945012581,-0.716641378732635,-0.656524184179196,-0.443207311122220,-0.153307830924333,0.0929027136997231,0.194299384764318,0.133333849692697,0.00200760112815458,-0.0734091267525216,-0.0482953245442872,0.0122452226344296,0.0303586487143663,0.00624728251536126,-0.0120998224422423,-0.00694492929337242,0.00283302658149668,0.00387401755206412,0.000528290225921795,-0.00111717962792064,-0.000785019702062054,-0.000152468600875194,0.000115516779003895,0.000129862160812496,7.76439894089127e-05,3.50448522267377e-05,1.23994507097935e-05,2.75372010567640e-06,-5.94378284089505e-07,-1.38207160959743e-06,-1.29809962554878e-06,-1.00557916921767e-06,-7.27146638544699e-07,-5.16792620060422e-07,-2.86042836218973e-07,-1.31139447355949e-07,-6.01223050370628e-08,-2.75637242328645e-08,0.000447893865002922,0.00642521501441267,0.0186586325227142,0.0375645422581885,0.0645887222320994,0.101722135478881,0.151434515733062,0.214251497250578,0.284550430487204,0.347166504218465,0.377770857077819,0.356691798816235,0.290491263887393,0.214821480639475,0.171157169894165,0.180650057923460,0.226710779899889,0.253615797306550,0.211714122208089,0.119523817877441,0.0257309682771814,-0.0605519278135995,-0.148836229833186,-0.232126926446408,-0.292576638892434,-0.319969505038006,-0.320615469469241,-0.303757615468790,-0.277339766519151,-0.247867300037540,-0.219246394603605,-0.193223136747351,-0.170196692497591,-0.149897178906652,-0.131819086999645,-0.115452698643699,0,0,0};
    // vector<double> testInit_vx = {25,25.1959570957096,25.3799476681111,25.5520535527010,25.7126069802945,25.8617236982102,25.9993196067227,26.1251210721813,26.2386749766761,26.3393626664354,26.4264415626754,26.4991393116505,26.5568332828900,26.5993678188334,26.6275453691334,26.6437299577606,26.6522544637989,26.6590523237561,26.6701839899342,26.6899450645089,26.7197894049475,26.7584494471400,26.8027241572937,26.8484386480360,26.8914756708861,26.9288947029550,26.9597915658305,26.9851790086739,27.0068956143047,27.0267568481598,27.0466251876306,27.0686742369044,27.0952954986105,27.1289933009374,27.1724078274808,27.2282934470621,27.2994764580358,27.3887843491802,27.4999430422820,27.6455193066015,27.8362932423902,28.0703206061306,28.3359766114023,28.6180282307945,28.8993721406745,29.1637686753722,29.3985594369482,29.5962599180534,29.7545940772456,29.8753675977371,29.9628549976479,30.0222333157544,30.0589235982200,30.0781986701199,30.0848950754799,30.0832436827724,30.0768099062241,30.0685147798035,30.0603644084452,30.0525427481796,30.0450365418215,30.0378330668588,30.0308601574306,30.0232348691551,30.0136964066003,30.0008199373796,29.9830373003128,29.9587226209466,29.9257137745154,29.8813567078171,29.8238222900622,29.7528259713682,29.6699715262558,29.5779417798453,29.4784234692673,29.3702288133682,29.2495369371910,29.1126923309355,28.9605213141043,28.8020633450011,28.6539979387315,28.5336426517633,28.4508758257402,28.4060582972729,28.3932911011410,28.4045889237670,28.4325839549146,28.4715641248942,28.5174096250838,28.5672568838995,28.6191595742158,28.6717893946774,28.7242119643261,28.7757330423841,28.8258304038944,28.8741117036166,28.9202892791041,28.9641653200413,28.9641653200413,28.9641653200413,28.9641653200413};
    // vector<double> testInit_vy = {0,0.0575329041195114,0.0856333180866542,0.100961983381395,0.111827743013351,0.122162117729785,0.134069978132741,0.148992340885012,0.168268208971792,0.193343844250877,0.226014113147856,0.268558291338035,0.323609758412883,0.393555691586765,0.479006753921131,0.576128452082085,0.674289161582138,0.758010431382191,0.814568065364696,0.839321947304284,0.832280157721235,0.792090964045790,0.714516953407634,0.595637725515646,0.438453828235297,0.261067348350973,0.0985613621679969,-0.0111434178127554,-0.0490909007148197,-0.0260951795020160,0.0219987276178669,0.0550021557596251,0.0554990867319406,0.0373285108030978,0.0253742225495608,0.0284052182511525,0.0359197352596593,0.0374660923179171,0.0344710867629065,0.0327520448586063,0.0334532890619471,0.0344122042976066,0.0345429692050130,0.0342664395941415,0.0340721277867004,0.0340343880340085,0.0340629812961382,0.0340951253953492,0.0341143442046089,0.0341230186729818,0.0341260878439496,0.0341267694578371,0.0341266223344995,0.0341262802375664,0.0341259589257779,0.0341257100200430,0.0341255300332512,0.0341254021142859,0.0341253313116036,0.0341252988513444,0.0341252839695857,0.0341252771468817,0.0342361419649517,0.0358265417209946,0.0404450151177062,0.0497431691420107,0.0657304766252043,0.0909092230308690,0.128393014053906,0.181425562878309,0.251858837751382,0.337791140775758,0.431298778666312,0.519588827878255,0.591492606068207,0.644666239889862,0.687031876002281,0.731747236874426,0.787863766552619,0.850639954004738,0.903044439699812,0.932629543134824,0.938998594688582,0.924010493744621,0.887169842795811,0.829712682784321,0.757292722662428,0.678092350128265,0.598732085408152,0.523544556826765,0.454896099767566,0.393542807679063,0.339273898123713,0.291446389027832,0.249318494845258,0.212215232739650,0.179586745858548,0.151009345204166,0.151009345204166,0.151009345204166,0.151009345204166};
    // vector<double> testInit_x = {15,21.2123709276871,27.4717650816256,33.7752305792511,40.1198667838301,46.5028285014671,52.9212744550482,59.3723190935267,65.8529869213558,72.3601697979788,78.8905911134632,85.4407867662265,92.0071200081254,98.5858577682400,105.173347024177,111.766326643842,118.362364319778,124.960298328139,131.560451337259,138.164427705384,144.774543357545,151.393137274882,158.021995394243,164.661990790943,171.312970285859,177.973907213315,184.643299078264,191.319656822634,198.001844275973,204.689177501526,211.381427753480,218.078865801072,224.782327402002,231.493254233629,238.213724670315,244.946484729046,251.694971103440,258.463320213244,265.256479543871,272.081413002891,278.947973961925,285.867109339218,292.848086717625,299.896849693145,307.015339838129,314.201372117343,321.449185002532,328.750524031616,336.095926753807,343.475872505662,350.881593123903,358.305490192394,365.741276939173,373.183990091196,380.629917534958,388.076469361475,395.522020548232,402.965748850959,410.407441819802,417.847158052058,425.284977271118,432.720975985064,440.155220195991,447.587657699281,455.017970975984,462.445510127467,469.869254835103,477.287789478823,484.699229626777,492.101094785482,499.490349611952,506.863697169060,514.218003790054,521.550666327938,528.859622423125,536.142871468006,543.397792971789,550.620841148538,557.808120065003,564.956954800041,572.067853473771,579.145531764674,586.198071180207,593.234820452857,600.264442903156,607.293883500299,614.328187074393,621.370779658528,628.423870469170,635.488804443054,642.566331232425,649.656795213724,656.760260728452,663.876590556016,671.005496923130,678.146578867129,685.299351265981,692.463268914390,699.632616765886,706.801964617382,713.971312468877};
    // vector<double> testInit_y = {2,2.00712040892568,2.02483900078288,2.04793247868734,2.07426784086491,2.10322698204600,2.13493887509829,2.16997134032326,2.20923625986000,2.25399022684300,2.30589096414483,2.36710042014556,2.44038854511474,2.52914664536222,2.63713704703399,2.76772308738093,2.92247774253740,3.09974254364686,3.29436859522445,3.49905795322805,3.70593940186983,3.90697543179150,4.09343680771396,4.25558466401635,4.38356629195583,4.47014069499869,4.51464919877579,4.52546825129501,4.51801350890298,4.50870830095535,4.50820131433603,4.51773112663522,4.53140702298319,4.54289558703456,4.55065582631087,4.55731169769710,4.56527270679498,4.57435511119814,4.58325822742101,4.59157792192863,4.59977165137424,4.60817084609696,4.61670490222352,4.62522091816401,4.63367866165174,4.64210768588698,4.65053557813081,4.65897098737480,4.66741275341440,4.67585797159232,4.68430464319095,4.69275177899563,4.70119898095013,4.70964612235756,4.71809318165996,4.72654017039087,4.73498710604104,4.74343400358405,4.75188087653280,4.76032773670148,4.76877459101100,4.77722144263433,4.78568201430658,4.79435313852514,4.80379268763884,4.81495459163138,4.82924588442435,4.84863198586694,4.87577335184278,4.91411723512647,4.96774154213510,5.04071802462608,5.13590242059664,5.25358653031751,5.39109660877623,5.54408656495917,5.70890068821316,5.88449216257909,6.07256283132007,6.27534794525045,6.49238809298617,6.71957546709938,6.95121261286961,7.18178304460640,7.40593902685152,7.61842448793817,7.81483604801823,7.99248271544283,8.15050554162308,8.28940116566206,8.41049530632968,8.51550012160774,8.60619525846452,8.68425469994367,8.75118104695767,8.80830155779739,8.85679190168331,8.89770725948810,8.93508581028122,8.97246436107433,9.00984291186744};

    // solve with DDP
    // -- IDM initial
    // DDP ddp(veh, in.numsteps, in.step, idm.opt_x, idm.opt_vx, idm.opt_y, idm.opt_ux, idm.opt_uy);    
    // -- Feedback initial
    DDP ddp(veh, in.numsteps, in.step, dddp.init_x, dddp.init_vx, dddp.init_y, dddp.init_ux, dddp.init_uy);    
    // -- DDP initial
    // DDP ddp(veh, in.numsteps, in.step, dddp.opt_x, dddp.opt_vx, dddp.opt_y, dddp.opt_ux, dddp.opt_uy);
    // DDP ddp(veh, in.numsteps, in.step, testInit_x, testInit_vx, testInit_y, testInit_vy, testInit_ux, testInit_uy);
    ddp.run(veh);
    ddp.exportSimData(0);

	/* end procedure */
	toc = clock();
	cpu_time = (double)(toc - tic) / CLOCKS_PER_SEC;
	fprintf(stderr, "-- Procedure Total CPU Time used: %.6f --\n", cpu_time);

	return 0;
}
